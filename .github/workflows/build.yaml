name: Build Guix Installer

on:
  schedule:
    - cron: '10 */4 * * *'
  workflow_dispatch:
    inputs:
      disable_substitutes:
        description: 'No substitute-urls'
        required: false
        default: false
        type: boolean

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 720
    steps:
      - name: Clean-up the disk
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          sudo docker builder prune -a
          df -h

      - name: Check substitute server availability
        id: check-substitutes
        run: |
          CANDIDATE_SERVERS=(
            "https://ci.guix.gnu.org"
            "https://bordeaux.guix.gnu.org"
            "https://bordeaux-singapore-mirror.cbaines.net"
          )
          AVAILABLE_SERVERS=""

          for server in "${CANDIDATE_SERVERS[@]}"; do
            echo "Checking $server..."
            if curl --silent --fail --location --max-time 15 --output /dev/null "$server/nix-cache-info"; then
              echo "  OK: $server is available"
              if [ -n "$AVAILABLE_SERVERS" ]; then
                AVAILABLE_SERVERS="$AVAILABLE_SERVERS $server"
              else
                AVAILABLE_SERVERS="$server"
              fi
            else
              echo "  FAIL: $server is not responding"
            fi
          done

          # Always include nonguix substitute server
          NONGUIX_SERVER="https://substitutes.nonguix.org"
          if [ -n "$AVAILABLE_SERVERS" ]; then
            AVAILABLE_SERVERS="$AVAILABLE_SERVERS $NONGUIX_SERVER"
          else
            AVAILABLE_SERVERS="$NONGUIX_SERVER"
          fi

          echo "Using substitute servers: $AVAILABLE_SERVERS"
          echo "GUIX_SUBSTITUTE_URLS=$AVAILABLE_SERVERS" >> $GITHUB_ENV

      - name: Git checkout
        uses: actions/checkout@v4

      - name: Guix cache
        uses: actions/cache/restore@v3
        with:
          path: ~/.cache/guix
          key: guix-cache-${{ hashFiles('guix/channels.scm') }}
          restore-keys: guix-cache-

      - name: Set LANG
        run: echo LANG=en_GB.utf8 >> $GITHUB_ENV

      - name: Download Guix
        run: curl -OL https://ftpmirror.gnu.org/gnu/guix/guix-binary-1.4.0.x86_64-linux.tar.xz

      - name: Install Guix
        run: |
          sudo tar --extract --file "guix-binary-1.4.0.x86_64-linux.tar.xz" -C / --no-overwrite-dir
          sudo groupadd --system guixbuild

          for i in $(seq -w 1 10); do
            sudo useradd -g guixbuild -G guixbuild -d /var/empty -s "$(which nologin)" -c "Guix build user $i" --system "guixbuilder${i}"
          done

          GUIX_PATH=/var/guix/profiles/per-user/root/current-guix

          sudo cp $GUIX_PATH/lib/systemd/system/gnu-store.mount /etc/systemd/system/

          sed "s|@@GUIX_SUBSTITUTE_URLS@@|$GUIX_SUBSTITUTE_URLS|g" guix-daemon.service.template | sudo tee /etc/systemd/system/guix-daemon.service > /dev/null
          sudo chmod 664 /etc/systemd/system/{gnu-store.mount,guix-daemon.service}
          sudo systemctl daemon-reload
          sudo systemctl enable --now gnu-store.mount guix-daemon.service

          echo "$GUIX_PATH/bin" >> $GITHUB_PATH

      - name: Authorize build farm
        if: ${{ !inputs.disable_substitutes }}
        run: |
          for F in /var/guix/profiles/per-user/root/current-guix/share/guix/*.pub; do
            sudo /var/guix/profiles/per-user/root/current-guix/bin/guix archive --authorize < $F
          done

      - name: Generate signing keys
        run: sudo /var/guix/profiles/per-user/root/current-guix/bin/guix archive --generate-key

      - name: Update Guix
        run: |
          SUBSTITUTE_ARGS=""
          if [ "${{ inputs.disable_substitutes }}" = "true" ]; then
            SUBSTITUTE_ARGS="--no-substitutes"
          else
            SUBSTITUTE_ARGS="--substitute-urls=$GUIX_SUBSTITUTE_URLS"
          fi
          for attempt in 1 2 3; do
            echo "Attempt $attempt of 3..."
            if timeout 300 sudo /var/guix/profiles/per-user/root/current-guix/bin/guix pull --fallback $SUBSTITUTE_ARGS -C ./guix/channels.scm; then
              echo "Guix update succeeded"
              exit 0
            fi
            echo "Attempt $attempt failed"
            [ $attempt -lt 3 ] && sleep 10
          done
          echo "All 3 attempts failed, skipping Guix update"
          exit 0

      - name: Set up Nonguix Substitutes
        if: ${{ !inputs.disable_substitutes }}
        run: sudo /var/guix/profiles/per-user/root/current-guix/bin/guix archive --authorize < ./keys/nonguix-signing-key.pub

      - name: Build ISO
        run: ./build-iso.sh
        env:
          GUIX_NO_SUBSTITUTES: ${{ inputs.disable_substitutes }}

      - name: Save Guix cache
        uses: actions/cache/save@v3
        if: always()
        with:
          path: ~/.cache/guix
          key: guix-cache-${{ hashFiles('guix/channels.scm') }}

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-logs
          path: /gnu/store/*.log

      - name: Compress ISO
        run: xz -9 -T0 guix-installer-${{ env.RELEASE_TAG }}.iso

      - name: Split ISO into parts
        run: |
          ISO_FILE="guix-installer-${{ env.RELEASE_TAG }}.iso.xz"
          split -b 1800M "$ISO_FILE" "${ISO_FILE}.part."
          sha256sum "$ISO_FILE" > "${ISO_FILE}.sha256"
          sha256sum ${ISO_FILE}.part.* > "${ISO_FILE}.parts.sha256"

      - name: Generate reconstruct script
        run: |
          sed -i 's/RELEASE_TAG="${1:-}"/RELEASE_TAG="${{ env.RELEASE_TAG }}"/' reconstruct-iso.sh
          sed -i '/^if \[ -z "\$RELEASE_TAG" \]/,/^fi$/d' reconstruct-iso.sh

      - name: Prepare Release Notes
        run: |
          cat > release-notes.md << 'EOF'
          This installer image was prepared with the following channel configuration:

          ```
          EOF
          cat ./guix/channels.scm >> release-notes.md
          echo '```' >> release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Guix Installer - ${{ env.RELEASE_TAG }}
          tag_name: v${{ env.RELEASE_TAG }}
          body_path: release-notes.md
          files: |
            guix-installer-${{ env.RELEASE_TAG }}.iso.xz.part.*
            guix-installer-${{ env.RELEASE_TAG }}.iso.xz.sha256
            guix-installer-${{ env.RELEASE_TAG }}.iso.xz.parts.sha256
            reconstruct-iso.sh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
